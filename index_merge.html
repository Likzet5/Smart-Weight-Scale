<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Scale Interface</title>
    <style>
        body {
          font-family: Arial, sans-serif;
        }
    
        .container {
          max-width: 500px;
          margin: 0 auto;
          padding: 20px;
        }
    
        .button {
          display: inline-block;
          padding: 10px 20px;
          font-size: 16px;
          background-color: #4CAF50;
          color: #fff;
          border: none;
          cursor: pointer;
        }
    
        .button:hover {
          background-color: #45a049;
        }
    
        .input-field {
          width: 100%;
          padding: 10px;
          font-size: 16px;
          border: 1px solid #ccc;
          border-radius: 4px;
          box-sizing: border-box;
        }
      </style>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h2>Raspberry Pico Web Bluetooth Serial Monitor and Weight logger</h2>
        <button id="connectButton" class="button" onclick="connectToDevice()">Connect</button>
        <button id="disconnectButton" class="button" onclick="disconnectFromDevice()" disabled>Disconnect</button>
        <br><br>
        <input type="text" id="messageInput" class="input-field" placeholder="Enter message">
        <button class="button" onclick="sendMessage()">Send Message</button>
        <button class="button" onclick="LED()">Toggle LED</button>
        <br><br>
        
        <button class="button" id="tareButton" onclick="tareButton()">Tare Scale</button>
        <button class="button" id="setMinWeightButton" onclick="setMinWeightButton()">Set Minimum Weight</button>
        <button class="button" id="setTrackingDurationButton" onclick="setTrackingDurationButton()">Set Tracking Duration</button>
        

        <!-- <button id="tareButton">Tare Scale</button> 
        <button id="setMinWeightButton">Set Minimum Weight</button>
        <button id="setTrackingDurationButton">Set Tracking Duration</button>
        -->
        <h3>
        <p>Current Weight: <span id="currentWeight">0 kg</span></p> 
        <p>Peak Weight: <span id="peakWeight">0 kg</span></p>
        <p>Average Weight: <span id="avgWeight">0 kg</span></p>
        <p>Elapsed Time: <span id="elapsedTime">0 s</span></p>
        </h3>
        <canvas id="weightChart" width="300" height="100"></canvas>
        <br><br>
        <pre id="log"></pre>
      </div>

    <script>
    let weightChart;
    let labels = [];
    let dataPoints = [];
    const delayBetweenPoints = 0;
    
    const previousY = (ctx) => ctx.index === 0 ? ctx.chart.scales.y.getPixelForValue(5) : ctx.chart.getDatasetMeta(ctx.datasetIndex).data[ctx.index - 1].getProps(['y'], true).y;
    
    const animation = {
        x: {
            type: 'number',
            easing: 'linear',
            duration: delayBetweenPoints,
            from: NaN,
            delay(ctx) {
                if (ctx.type !== 'data' || ctx.xStarted) {
                    return 0;
                }
                ctx.xStarted = true;
                return ctx.index * delayBetweenPoints;
            }
        },
        y: {
            type: 'number',
            easing: 'linear',
            duration: delayBetweenPoints,
            from: previousY,
            delay(ctx) {
                if (ctx.type !== 'data' || ctx.yStarted) {
                    return 0;
                }
                ctx.yStarted = true;
                return ctx.index * delayBetweenPoints;
            }
        }
    };
    
    $(document).ready(function () {
        const ctx = document.getElementById('weightChart').getContext('2d');
        weightChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Weight (kg)',
                    data: dataPoints,
                    fill: false,
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.2,
                    pointRadius: 5
                }]
            },
            options: {
                animation: animation,
                scales: {
                    x: {
                        type: 'linear',
                        suggestedMax: 7,
                        position: 'bottom',
                        title: {
                            display: true,
                            text: 'Elapsed Time (s)'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        suggestedMax: 40,
                        title: {
                            display: true,
                            text: 'Weight (kg)'
                        }
                    }
                }
            }
        });
    
        const socket = io.connect('http://' + document.domain + ':' + location.port);
    
        socket.on('response_data', function (data) {
            $('#currentWeight').text(data.weight + ' kg');
            $('#peakWeight').text(data.peak_weight + ' kg');
            $('#avgWeight').text(data.avg_weight + ' kg');
            $('#elapsedTime').text(data.elapsed_time + ' s');
    
            if (data.clear_chart) {
                labels = [];
                dataPoints = [];
            }
    
            if (data.tracking) {
                labels.push(data.elapsed_time);
                dataPoints.push(data.weight);
    
                weightChart.data.labels = labels;
                weightChart.data.datasets[0].data = dataPoints;
    
                const suggestedMax = data.peak_weight + 10;
                weightChart.options.scales.y.suggestedMax = suggestedMax;
                weightChart.update();
            }
        });
    
        $('#tareButton').click(function () {
            socket.emit('tare');
        });
    
        $('#setMinWeightButton').click(function () {
            const minWeight = prompt('Enter minimum weight (kg):');
            if (minWeight !== null) {
                socket.emit('set_min_weight', {min_weight: parseFloat(minWeight)});
            }
        });
    
        $('#setTrackingDurationButton').click(function () {
            const trackingDuration = prompt('Enter tracking duration (seconds):');
            if (trackingDuration !== null) {
                socket.emit('set_tracking_duration', {tracking_duration: parseFloat(trackingDuration)});
            }
        });
    });

    let device;
    let logElement;
    let writeCharacteristic;
    let readCharacteristic;

    function log(message) {
      logElement.innerHTML += message + '\n';
    }

    async function connectToDevice() {
      try {
        logElement = document.getElementById('log');
        log('Requesting Bluetooth Device...');

        if (device && device.gatt.connected) {
          log('Already connected to ' + device.name);
          return;
        }

        device = await navigator.bluetooth.requestDevice({
          filters: [{ name: 'Weight'} 
                    ,{ name: 'mpy-uart'}], //Change name here!
          optionalServices: ['6e400001-b5a3-f393-e0a9-e50e24dcca9e']
        });

        log('Connecting to GATT Server...');
        const server = await device.gatt.connect();

        log('Getting Serial Service...');
        const service = await server.getPrimaryService('6e400001-b5a3-f393-e0a9-e50e24dcca9e');

        log('Getting Serial Port Write Characteristic...');
        writeCharacteristic = await service.getCharacteristic('6e400002-b5a3-f393-e0a9-e50e24dcca9e');

        log('Getting Serial Port Read Characteristic...');
        readCharacteristic = await service.getCharacteristic('6e400003-b5a3-f393-e0a9-e50e24dcca9e');

        //Add mtu size upgrade here
        //await device.gatt.requestMtu(250);
        //await device.gatt.onMtuChanged()

        log('Enabling notifications...');
        await readCharacteristic.startNotifications();
        readCharacteristic.addEventListener('characteristicvaluechanged', handleData);

        device.ongattserverdisconnected = handleDisconnect; // Assigning the disconnect handler

        log('Connected to ' + device.name);

        document.getElementById('connectButton').disabled = true;
        document.getElementById('disconnectButton').disabled = false;
      } catch (error) {
        log('Error: ' + error);
      }
    }


    function handleDisconnect() {
      log('Connection lost. Device disconnected.');
      document.getElementById('connectButton').disabled = false;
      document.getElementById('disconnectButton').disabled = true;
      alert('Connection lost. Device disconnected.');
    }

    function disconnectFromDevice() {
      if (device && device.gatt.connected) {
        device.gatt.disconnect();
      }
    }

    function handleData(event) {
      const value = event.target.value;
      const decoder = new TextDecoder('utf-8');
      const data = decoder.decode(value);
      stringB = "C "
      if ( stringB.indexOf( data ) > -1 ) { // String B contains String A
        log('Weight: ' + data);
        }
      else{
        log('Received: ' + data);
      }
      
    }

    async function sendMessage() {
      try {
        const messageInput = document.getElementById('messageInput');
        const message = messageInput.value;
        const encoder = new TextEncoder('utf-8');
        const data = encoder.encode(message);
        await writeCharacteristic.writeValue(data);
        log('Sent: ' + message);
        messageInput.value = '';
      } catch (error) {
        log('Error: ' + error);
      }
    }

    async function LED() {
      try {
        const messageInput = 'toggle';
        const message =  'toggle'; // messageInput.value;
        const encoder = new TextEncoder('utf-8');
        const data = encoder.encode(message);
        await writeCharacteristic.writeValue(data);
        log('Sent: ' + message);
        messageInput.value = '';
      } catch (error) {
        log('Error: ' + error);
      }
    }
  



    </script>
</body>
</html>
